<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Story - M·∫°ng x√£ h·ªôi</title>
  <style>
    /* Reset & Base */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f0f2f5; }
    .container { max-width: 600px; margin: 20px auto; }
    .card { background: #fff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; }
    .card-header, .card-footer { padding: 12px 16px; }
    .card-header { display: flex; align-items: center; }
    .avatar { width: 40px; height: 40px; border-radius: 50%; background: #ccc; margin-right: 10px; }
    .btn { border: none; background: #1877f2; color: #fff; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn:disabled { background: #a3bffa; }
    textarea { width: 100%; border: 1px solid #ccd0d5; border-radius: 8px; padding: 10px; resize: none; font-size: 15px; }
    .actions { display: flex; justify-content: space-between; margin-top: 8px; }
    .actions .action-btn { display: flex; align-items: center; color: #65676b; cursor: pointer; font-size: 14px; }
    .actions .action-btn span { margin-left: 6px; }
    .story-list .story { border-top: 1px solid #e4e6eb; }
    .story:first-child { border-top: none; }
    .story-content { padding: 16px; }
    .story-content p { margin-bottom: 10px; line-height: 1.5; }
    .story-content img { max-width: 100%; border-radius: 8px; margin-bottom: 10px; }
    .comment-section { padding: 0 16px 16px; }
    .comment-list { margin-bottom: 10px; }
    .comment { display: flex; align-items: flex-start; margin-bottom: 8px; }
    .comment .avatar-sm { width: 32px; height: 32px; border-radius: 50%; background: #ccc; margin-right: 8px; }
    .comment .text { background: #f0f2f5; padding: 8px 12px; border-radius: 12px; font-size: 14px; }
    .comment-input { display: flex; align-items: center; }
    .comment-input input { flex: 1; border: 1px solid #ccd0d5; border-radius: 16px; padding: 8px 12px; font-size: 14px; }
    .emoji-picker, .sticker-picker { display: none; position: absolute; bottom: 50px; background: #fff; border: 1px solid #ccd0d5; border-radius: 8px; padding: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); max-width: 200px; }
    .emoji-picker span, .sticker-picker img { cursor: pointer; font-size: 20px; margin: 4px; }
    .sticker-picker { display: flex; flex-wrap: wrap; }
    /* Header */
    header { background: #fff; padding: 10px 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 10; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 20px; color: #1877f2; }
  </style>
</head>
<body>
  <header>
    <h1>Story</h1>
    <button id="logoutBtn" class="btn">ƒêƒÉng xu·∫•t</button>
  </header>
  <div class="container">
    <!-- Post Box -->
    <div class="card">
      <div class="card-header">
        <div class="avatar"></div>
        <textarea id="storyInput" rows="3" placeholder="B·∫°n ƒëang nghƒ© g√¨?"></textarea>
      </div>
      <div class="card-footer">
        <div style="position: relative; display: inline-block;">
          <button id="emojiBtn" class="action-btn">üòÄ <span>Emoji</span></button>
          <div id="emojiPicker" class="emoji-picker"></div>
        </div>
        <div style="position: relative; display: inline-block;">
          <button id="stickerBtn" class="action-btn">üìå <span>Sticker</span></button>
          <div id="stickerPicker" class="sticker-picker"></div>
        </div>
        <button id="postStoryBtn" class="btn">ƒêƒÉng</button>
      </div>
    </div>

    <!-- Story Feed -->
    <div class="story-list" id="storiesContainer"></div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // C·∫•u h√¨nh Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBk3M_eefgKjG_xgknpQ7yU7dQzjIoyUH4",
      authDomain: "story-2f386.firebaseapp.com",
      databaseURL: "https://story-2f386-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "story-2f386",
      storageBucket: "story-2f386.appspot.com",
      messagingSenderId: "788401479499",
      appId: "1:788401479499:web:e0938c31b136d9d4c9d2ce"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // UI Elements
    const storyInput = document.getElementById('storyInput');
    const postStoryBtn = document.getElementById('postStoryBtn');
    const storiesContainer = document.getElementById('storiesContainer');
    const logoutBtn = document.getElementById('logoutBtn');
    const emojiBtn = document.getElementById('emojiBtn');
    const emojiPicker = document.getElementById('emojiPicker');
    const stickerBtn = document.getElementById('stickerBtn');
    const stickerPicker = document.getElementById('stickerPicker');

    // M·ªôt v√†i emoji & sticker m·∫´u
    const emojis = ['üòÄ','üòÇ','üòç','üò¢','üëç','üéâ'];
    const stickers = ['sticker1.png','sticker2.png','sticker3.png']; // Thay b·∫±ng ƒë∆∞·ªùng d·∫´n th·ª±c

    // Render emoji & stickers
    emojis.forEach(e => { const span = document.createElement('span'); span.textContent = e; span.onclick = () => { storyInput.value += e; emojiPicker.style.display = 'none'; }; emojiPicker.appendChild(span); });
    stickers.forEach(s => { const img = document.createElement('img'); img.src = s; img.width=50; img.onclick = () => { storyInput.value += `<img src='${s}'/>`; stickerPicker.style.display='none'; }; stickerPicker.appendChild(img); });

    // Toggle picker
    emojiBtn.onclick = () => emojiPicker.style.display = emojiPicker.style.display === 'block' ? 'none' : 'block';
    stickerBtn.onclick = () => stickerPicker.style.display = stickerPicker.style.display === 'flex' ? 'none' : 'flex';

    // Auth state
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    auth.onAuthStateChanged(user => { if (!user) window.location.reload(); });
    logoutBtn.onclick = () => auth.signOut();

    // Post story
    postStoryBtn.onclick = async () => {
      const text = storyInput.value.trim();
      if (!text) return alert('B·∫°n ph·∫£i nh·∫≠p n·ªôi dung.');
      postStoryBtn.disabled = true;
      const newRef = db.ref('stories').push();
      await newRef.set({ uid: auth.currentUser.uid, nickname: auth.currentUser.email.split('@')[0], text, timestamp: Date.now() });
      storyInput.value = '';
      postStoryBtn.disabled = false;
    };

    // Load feed
    function loadStories() {
      db.ref('stories').orderByChild('timestamp').on('value', snap => {
        storiesContainer.innerHTML = '';
        const data = snap.val() || {};
        Object.entries(data).sort((a,b) => b[1].timestamp - a[1].timestamp).forEach(([key, story]) => {
          const card = document.createElement('div'); card.className = 'card story';
          card.innerHTML = `
            <div class="card-header">
              <div class="avatar-sm"></div>
              <div><strong>${story.nickname}</strong><br><small>${new Date(story.timestamp).toLocaleString()}</small></div>
            </div>
            <div class="story-content">${story.text}</div>
            <div class="card-footer comment-section" id="comments-${key}"></div>
          `;
          // TODO: th√™m comment v√† ph·∫£n h·ªìi
          storiesContainer.appendChild(card);
        });
      });
    }
    loadStories();
  </script>
</body>
</html>
