<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Story - Chia sẻ câu chuyện</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 1rem; background: #f9f9f9; }
    h1 { text-align: center; }
    section { margin-bottom: 20px; }
    #authSection, #logoutSection, #storySection { text-align: center; }
    #storySection, #logoutSection { display: none; }
    .btn { padding: 8px 12px; cursor: pointer; margin: 5px; }
    input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box; }
    .story { background: white; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; }
    .story img { max-width: 100%; border-radius: 5px; margin-top: 10px; }
    .comment-section { margin-top: 10px; }
    .comments { margin-top: 10px; padding-left: 15px; border-left: 2px solid #eee; text-align: left; }
  </style>
</head>
<body>
  <h1>Story - Chia sẻ câu chuyện</h1>

  <!-- Đăng ký / Đăng nhập -->
  <section id="authSection">
    <h2>Đăng nhập / Đăng ký</h2>
    <input type="email" id="emailInput" placeholder="Email" />
    <input type="password" id="passwordInput" placeholder="Mật khẩu" />
    <button id="loginBtn" class="btn">Đăng nhập</button>
    <button id="registerBtn" class="btn">Đăng ký</button>
  </section>

  <!-- Đăng xuất -->
  <section id="logoutSection">
    <span id="userEmail"></span>
    <button id="logoutBtn" class="btn">Đăng xuất</button>
  </section>

  <!-- Viết câu chuyện -->
  <section id="storySection">
    <h2>Viết câu chuyện</h2>
    <textarea id="storyInput" rows="4" placeholder="Viết câu chuyện của bạn..."></textarea>
    <input type="file" id="imageInput" accept="image/*" />
    <button id="postStoryBtn" class="btn">Đăng câu chuyện</button>
  </section>

  <!-- Danh sách câu chuyện -->
  <section id="storyList">
    <h2>Các câu chuyện</h2>
    <div id="storiesContainer"></div>
  </section>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // Cấu hình Firebase (đã đúng định dạng)
    const firebaseConfig = {
      apiKey: "AIzaSyBk3M_eefgKjG_xgknpQ7yU7dQzjIoyUH4",
      authDomain: "story-2f386.firebaseapp.com",
      projectId: "story-2f386",
      storageBucket: "story-2f386.appspot.com",
      messagingSenderId: "788401479499",
      appId: "1:788401479499:web:e0938c31b136d9d4c9d2ce"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Giữ trạng thái đăng nhập sau reload
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

    // Phần tử DOM
    const authSection = document.getElementById('authSection');
    const logoutSection = document.getElementById('logoutSection');
    const userEmailSpan = document.getElementById('userEmail');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const storySection = document.getElementById('storySection');
    const postStoryBtn = document.getElementById('postStoryBtn');
    const storyInput = document.getElementById('storyInput');
    const imageInput = document.getElementById('imageInput');
    const storiesContainer = document.getElementById('storiesContainer');

    // Xử lý thay đổi trạng thái auth
    auth.onAuthStateChanged(user => {
      if (user) {
        authSection.style.display = 'none';
        logoutSection.style.display = 'block';
        storySection.style.display = 'block';
        userEmailSpan.textContent = user.email;
        loadStories();
      } else {
        authSection.style.display = 'block';
        logoutSection.style.display = 'none';
        storySection.style.display = 'none';
        storiesContainer.innerHTML = '';
      }
    });

    // Đăng ký
    registerBtn.onclick = () => {
      console.log('Clicked Register:', emailInput.value, passwordInput.value);
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!email || !pass) return alert('Vui lòng điền email và mật khẩu');
      auth.createUserWithEmailAndPassword(email, pass)
        .then(cred => alert('Đăng ký thành công: ' + cred.user.email))
        .catch(err => alert('Đăng ký thất bại: ' + err.message));
    };

    // Đăng nhập
    loginBtn.onclick = () => {
      console.log('Clicked Login:', emailInput.value);
      const email = emailInput.value.trim();
      const pass = passwordInput.value.trim();
      if (!email || !pass) return alert('Vui lòng điền email và mật khẩu');
      auth.signInWithEmailAndPassword(email, pass)
        .catch(err => alert('Đăng nhập thất bại: ' + err.message));
    };

    // Đăng xuất
    logoutBtn.onclick = () => auth.signOut();

    // Đăng story
    postStoryBtn.onclick = async () => {
      const user = auth.currentUser;
      if (!user) return alert('Vui lòng đăng nhập');
      const text = storyInput.value.trim();
      if (!text && !imageInput.files.length) return alert('Bạn phải nhập câu chuyện hoặc chọn ảnh');
      postStoryBtn.disabled = true;
      let imageUrl = null;
      if (imageInput.files.length) {
        try { imageUrl = await uploadImage(imageInput.files[0]); }
        catch { return alert('Upload ảnh thất bại'); }
      }
      const newRef = db.ref('stories').push();
      await newRef.set({
        uid: user.uid,
        nickname: user.email.split('@')[0],
        text, imageUrl, timestamp: Date.now()
      });
      storyInput.value = '';
      imageInput.value = '';
      postStoryBtn.disabled = false;
    };

    // Tải story
    function loadStories() {
      db.ref('stories').orderByChild('timestamp').on('value', snap => {
        storiesContainer.innerHTML = '';
        const data = snap.val() || {};
        Object.keys(data).sort((a,b) => data[b].timestamp - data[a].timestamp)
          .forEach(key => storiesContainer.appendChild(createStoryElement(data[key])));
      });
    }

    // Tạo phần tử story
    function createStoryElement(story) {
      const div = document.createElement('div'); div.className = 'story';
      div.innerHTML = `
        <strong>${story.nickname}</strong> <small>${new Date(story.timestamp).toLocaleString()}</small>
        <p>${story.text || ''}</p>
        ${story.imageUrl ? `<img src="${story.imageUrl}" />` : ''}
      `;
      return div;
    }

    // Upload image
    const CLOUD_NAME = 'dvtm9plhh', UPLOAD_PRESET = 'Story web';
    function uploadImage(file) {
      const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
      const fd = new FormData(); fd.append('file', file); fd.append('upload_preset', UPLOAD_PRESET);
      return fetch(url, { method:'POST', body: fd })
        .then(res => res.json()).then(data => data.secure_url);
    }
  </script>
</body>
</html>
