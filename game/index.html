<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Game Arena</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#333; }
    #gameCanvas { display:block; background:#222; }
    #hud { position:absolute; top:10px; left:10px; color:#fff; font-family:sans-serif; }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hud"></div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Firebase config (full values)
    const firebaseConfig = {
      apiKey: "AIzaSyBk3M_eefgKjG_xgknpQ7yU7dQzjIoyUH4",
      authDomain: "story-2f386.firebaseapp.com",
      databaseURL: "https://story-2f386-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "story-2f386",
      storageBucket: "story-2f386.appspot.com",
      messagingSenderId: "788401479499",
      appId: "1:788401479499:web:e0938c31b136d9d4c9d2ce"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    class Player {
      constructor(id, x, y) {
        this.id = id;
        this.x = x;
        this.y = y;
        this.health = 100;
        this.dead = false;
      }
      draw() {
        // body
        ctx.fillStyle = '#000';
        ctx.beginPath(); ctx.arc(this.x, this.y, 20, 0, Math.PI*2); ctx.fill();
        // sword
        ctx.strokeStyle = '#fff'; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(this.x, this.y);
        ctx.lineTo(this.x + 30, this.y);
        ctx.stroke();
      }
    }

    let players = {};
    let localId;
    const hud = document.getElementById('hud');

    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    auth.onAuthStateChanged(user => {
      if (!user) window.location = 'index.html';
      localId = user.uid;
      spawnPlayer();
      setupListeners();
      gameLoop();
    });

    function spawnPlayer() {
      const startX = canvas.width/2, startY = canvas.height/2;
      players[localId] = new Player(localId, startX, startY);
      writePlayer(localId, startX, startY, 100);
    }

    function writePlayer(id, x, y, health) {
      db.ref(`game/players/${id}`).set({ x, y, health, lastUpdate: Date.now() });
    }

    canvas.addEventListener('mousemove', e => {
      const p = players[localId];
      if (p.dead) return;
      p.x = e.clientX; p.y = e.clientY;
      writePlayer(localId, p.x, p.y, p.health);
    });

    canvas.addEventListener('click', e => {
      Object.values(players).forEach(p => {
        if (p.id === localId || p.dead) return;
        const dx = e.clientX - p.x, dy = e.clientY - p.y;
        const dist = Math.hypot(dx, dy);
        if (dist < 40) {
          const dmg = dist < 20 ? 10 : 5;
          p.health = Math.max(0, p.health - dmg);
          writePlayer(p.id, p.x, p.y, p.health);
          if (p.health === 0) handleDeath(p.id);
        }
      });
    });

    function handleDeath(id) {
      players[id].dead = true;
      setTimeout(() => {
        if (id === localId) spawnPlayer();
      }, 30000);
    }

    function setupListeners() {
      db.ref('game/players').on('value', snap => {
        const data = snap.val() || {};
        Object.entries(data).forEach(([id, info]) => {
          if (!players[id]) players[id] = new Player(id, info.x, info.y);
          players[id].x = info.x; players[id].y = info.y;
          players[id].health = info.health;
        });
        // remove disconnected
        Object.keys(players).forEach(id => {
          if (!data[id]) delete players[id];
        });
      });
    }

    function gameLoop() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      Object.values(players).forEach(p => {
        if (p.health > 0) p.draw();
      });
      updateHud();
      requestAnimationFrame(gameLoop);
    }

    function updateHud() {
      const me = players[localId];
      hud.textContent = me ? `MÃ¡u: ${me.health}` : '';
    }

    window.addEventListener('beforeunload', () => {
      db.ref(`game/players/${localId}`).remove();
    });
  </script>
</body>
</html>
