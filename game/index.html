<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Debug Multiplayer Game</title>
  <style>body,html{margin:0;padding:0;overflow:hidden;background:#222;}#gameCanvas{display:block;width:100vw;height:100vh;}#hud{position:absolute;top:10px;left:10px;color:#fff;}#log{position:absolute;bottom:10px;left:10px;color:#0f0;font-family:monospace;white-space:pre-wrap;max-height:30vh;overflow:auto;width:300px;}</style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="hud">HP:</div>
  <div id="message">Đang kết nối...</div>
  <div id="log"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const logEl = document.getElementById('log');
    function log(msg) { logEl.textContent += msg + '\n'; }

    const config={apiKey:"AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",authDomain:"test-game-8a541.firebaseapp.com",databaseURL:"https://test-game-8a541-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"test-game-8a541",storageBucket:"test-game-8a541.appspot.com",messagingSenderId:"396403313237",appId:"1:396403313237:web:3eeb142c4ffaffbd5962dc"};
    firebase.initializeApp(config);
    const db=firebase.database();
    const canvas=document.getElementById('gameCanvas'); const ctx=canvas.getContext('2d');
    canvas.width=innerWidth; canvas.height=innerHeight;
    let players={}; let localId='p_'+Math.random().toString(36).substr(2,5);
    log('LocalId: '+localId);

    // debug read
    db.ref('game/players').once('value').then(snap=>{ log('Initial players: '+JSON.stringify(snap.val())); });
    db.ref('game/players/'+localId).set({x:10,y:10,health:100}).then(()=>log('Set own node'));  
    db.ref('game/players/'+localId).on('value',snap=>{ log('Own data changed: '+JSON.stringify(snap.val())); });

    // listen all
    db.ref('game/players').on('value',snap=>{
      log('All data: '+JSON.stringify(snap.val()));
    });

    // draw local dot
    function loop(){ ctx.clearRect(0,0,canvas.width,canvas.height); for(let id in players){ const p=players[id]; ctx.fillStyle=id===localId?'#0f0':'#f00'; ctx.beginPath(); ctx.arc(p.x,p.y,10,0,2*Math.PI); ctx.fill(); } requestAnimationFrame(loop); }
    loop();

    // update on change
    db.ref('game/players').on('child_added',snap=>{ const v=snap.val(); players[snap.key]=v; log('child_added '+snap.key); });
    db.ref('game/players').on('child_changed',snap=>{ const v=snap.val(); players[snap.key]=v; log('child_changed '+snap.key); });
    db.ref('game/players').on('child_removed',snap=>{ delete players[snap.key]; log('child_removed '+snap.key); });

    // move test
    window.addEventListener('mousemove',e=>{ players[localId]={x:e.clientX,y:e.clientY,health:players[localId]?.health||100}; db.ref('game/players/'+localId).update({x:e.clientX,y:e.clientY}); });

  </script>
</body>
</html>
