<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stickman Multiplayer Animated Minimal</title>
  <style>body { margin:0; overflow:hidden; background:#222; }</style>
</head>
<body>
<canvas id="game" width="900" height="550"></canvas>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
  authDomain: "test-game-8a541.firebaseapp.com",
  databaseURL: "https://test-game-8a541-default-rtdb.firebaseio.com",
  projectId: "test-game-8a541",
  storageBucket: "test-game-8a541.appspot.com",
  messagingSenderId: "396403313237",
  appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let players = {};
let localId = null;
let x = Math.random()*canvas.width;
let y = Math.random()*canvas.height;
let color = '#' + Math.floor(Math.random()*16777215).toString(16);

function promptNick(){
  let n = prompt('Nickname?');
  if(!n||n.length<2) return promptNick();
  return n;
}
let nickname = promptNick();

function connectGame(){
  const ref = db.ref('players').push();
  localId = ref.key;
  ref.set({nickname, color, x, y});
  ref.onDisconnect().remove();
  setInterval(()=>{
    if(localId) db.ref('players/'+localId).update({x,y});
  },70);
  db.ref('players').on('value', snap => { players = snap.val()||{}; });
  canvas.addEventListener('mousemove', e => {
    const rect = canvas.getBoundingClientRect();
    x = e.clientX - rect.left;
    y = e.clientY - rect.top;
  });
  renderLoop();
}

// Animation state for walking legs
function renderStickman(x, y, color, nickname, time){
  ctx.save();
  ctx.strokeStyle=color; ctx.lineWidth=4;
  ctx.translate(x, y);
  ctx.font='bold 15px Arial';
  ctx.fillStyle='#fff';
  ctx.textAlign='center';
  ctx.fillText(nickname,0,-20);

  // Body
  ctx.beginPath(); ctx.moveTo(0,-13); ctx.lineTo(0,22); ctx.stroke();

  // Animate legs
  let legAngle = Math.sin(time/200+Math.abs(x+y)/500)*0.4;
  ctx.save();
  ctx.rotate(legAngle);
  ctx.beginPath(); ctx.moveTo(0,22); ctx.lineTo(-13,42); ctx.stroke(); // left leg
  ctx.restore();
  ctx.save();
  ctx.rotate(-legAngle);
  ctx.beginPath(); ctx.moveTo(0,22); ctx.lineTo(13,42); ctx.stroke(); // right leg
  ctx.restore();

  // Animate arms swinging a little
  let armAngle = Math.cos(time/220+Math.abs(x+y)/480)*0.3;
  ctx.save();
  ctx.rotate(armAngle);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-16,14); ctx.stroke(); // left arm
  ctx.restore();
  ctx.save();
  ctx.rotate(-armAngle);
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(16,14); ctx.stroke(); // right arm
  ctx.restore();

  // Head
  ctx.beginPath(); ctx.arc(0,-18,10,0,2*Math.PI); ctx.stroke();
  ctx.restore();
}

function renderLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  let t = Date.now();
  for(const pid in players){
    const p = players[pid];
    if(p) renderStickman(p.x, p.y, p.color||'#fff', p.nickname||'', t);
  }
  requestAnimationFrame(renderLoop);
}
connectGame();
</script>
</body>
</html>
