<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Game Stickman Multiplayer</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#222; font-family:sans-serif; }
    #authContainer { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#333; padding:20px; border-radius:8px; color:#fff; z-index:2; }
    #authContainer input { display:block; width:200px; margin:10px auto; padding:8px; border:none; border-radius:4px; }
    #authContainer button { padding:8px 16px; margin:5px; border:none; border-radius:4px; cursor:pointer; }
    #hud { position:absolute; top:10px; left:10px; color:#fff; z-index:1; }
    #message { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:24px; z-index:1; }
    canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="authContainer">
    <h3>Đăng nhập / Đăng ký</h3>
    <input id="emailInput" type="email" placeholder="Email" />
    <input id="passwordInput" type="password" placeholder="Mật khẩu" />
    <button id="loginBtn">Đăng nhập</button>
    <button id="registerBtn">Đăng ký</button>
  </div>

  <div id="hud" style="display:none;">
    HP: <span id="hpVal">--</span> | Kills: <span id="killCount">0</span>
  </div>
  <div id="message">Đang kết nối...</div>
  <canvas id="gameCanvas"></canvas>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
      authDomain: "test-game-8a541.firebaseapp.com",
      databaseURL: "https://test-game-8a541-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "test-game-8a541",
      storageBucket: "test-game-8a541.appspot.com",
      messagingSenderId: "396403313237",
      appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM elements
    const authContainer = document.getElementById('authContainer');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');
    const hud = document.getElementById('hud');
    const hpVal = document.getElementById('hpVal');
    const killCountEl = document.getElementById('killCount');
    const message = document.getElementById('message');
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Resize canvas
    function resize(){ canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    let localId, killCount=0;
    let players={}, floats=[];

    // Auth handlers
    registerBtn.onclick = () => {
      auth.createUserWithEmailAndPassword(emailInput.value, passwordInput.value)
        .catch(e=>alert(e.message));
    };
    loginBtn.onclick = () => {
      auth.signInWithEmailAndPassword(emailInput.value, passwordInput.value)
        .catch(e=>alert(e.message));
    };

    auth.onAuthStateChanged(user => {
      if(user){
        localId = user.uid;
        // init killCount on DB if not exists
        db.ref(`users/${localId}/kills`).once('value').then(s=>{
          if(s.val()===null) db.ref(`users/${localId}`).set({ email: user.email, kills: 0 });
        });
        authContainer.style.display = 'none';
        hud.style.display = 'block';
        StartGame();
      } else {
        authContainer.style.display = 'block';
        hud.style.display = 'none';
      }
    });

    function StartGame(){
      showMsg('Đang kết nối...');
      // spawn
      db.ref(`game/players/${localId}`).set({ x:canvas.width/2, y:canvas.height/2, health:100 });
      // listen players
      db.ref('game/players').on('value', snap=>{
        const data = snap.val()||{}; players={};
        Object.entries(data).forEach(([id,info])=>{
          players[id] = { ...info, id }; // simple object
        });
        hideMsg();
      });
      // listen killCount updates
      db.ref(`users/${localId}/kills`).on('value', s=>{
        killCount = s.val()||0;
        killCountEl.textContent = killCount;
      });
      // game loop
      render();
    }

    function showMsg(txt){ message.textContent=txt; message.style.display='block'; }
    function hideMsg(){ message.style.display='none'; }

    // Movement & attack
    window.addEventListener('mousemove', e=>{
      if(!players[localId]||players[localId].health<=0) return;
      db.ref(`game/players/${localId}`).update({ x:e.clientX, y:e.clientY });
    });
    window.addEventListener('click', e=>{
      Object.values(players).forEach(p=>{
        if(p.id===localId||p.health<=0) return;
        const d=Math.hypot(e.clientX-p.x, e.clientY-p.y);
        if(d<30){
          let dmg = d<15?10:5;
          const newHp = Math.max(0, p.health-dmg);
          db.ref(`game/players/${p.id}/health`).set(newHp);
          floats.push({ x:p.x, y:p.y-25, text:'-'+dmg+'hp', life:60 });
          if(newHp===0){
            // increment killCount
            db.ref(`users/${localId}/kills`).transaction(k=> (k||0)+1);
            setTimeout(()=> db.ref(`game/players/${p.id}/health`).set(100), 30000);
          }
        }
      });
    });

    // Render
    function render(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      Object.values(players).forEach(p=>{
        // draw health bar
        ctx.fillStyle='#444'; ctx.fillRect(p.x-20,p.y-40,40,6);
        ctx.fillStyle='#0f0'; ctx.fillRect(p.x-20,p.y-40,(p.health/100)*40,6);
        // draw stickman
        ctx.strokeStyle='#fff'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(p.x,p.y-20,10,0,2*Math.PI); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y-10); ctx.lineTo(p.x,p.y+20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x-15,p.y); ctx.lineTo(p.x+15,p.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y+20); ctx.lineTo(p.x-10,p.y+35); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y+20); ctx.lineTo(p.x+10,p.y+35); ctx.stroke();
      });
      // floating texts
      floats = floats.filter(f=>f.life>0);
      floats.forEach(f=>{
        ctx.globalAlpha = f.life/60;
        ctx.fillStyle = '#ff0'; ctx.fillText(f.text,f.x,f.y);
        f.y -= 0.5; f.life--;
        ctx.globalAlpha = 1;
      });
      // HUD
      const me = players[localId]||{};
      document.getElementById('hpVal').textContent = me.health||0;
      requestAnimationFrame(render);
    }

    window.addEventListener('beforeunload', ()=>{
      if(localId) db.ref(`game/players/${localId}`).remove();
    });
  </script>
</body>
</html>
