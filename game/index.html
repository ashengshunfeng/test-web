<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Stickman Multiplayer</title>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; background:#222; font-family:sans-serif; }
    #authContainer { position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#333; padding:20px; border-radius:8px; color:#fff; z-index:2; }
    #authContainer input, #authContainer button { display:block; width:220px; margin:10px auto; padding:8px; border:none; border-radius:4px; font-size:16px; }
    #hud { position:absolute; top:10px; left:10px; color:#fff; z-index:1; }
    #message { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:#fff; font-size:24px; z-index:1; }
    canvas { display:block; width:100vw; height:100vh; }
  </style>
</head>
<body>
  <div id="authContainer">
    <h3>Đăng ký / Đăng nhập</h3>
    <input id="email" type="email" placeholder="Email" />
    <input id="pass" type="password" placeholder="Mật khẩu" />
    <button id="btnRegister">Đăng ký</button>
    <button id="btnLogin">Đăng nhập</button>
  </div>
  <div id="hud" style="display:none;">HP: <span id="hp">--</span> | Kills: <span id="kills">0</span></div>
  <div id="message">Đang kết nối...</div>
  <canvas id="canvas"></canvas>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { getDatabase, ref, set, update, onValue, runTransaction, remove } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js';

    // Firebase config (theo bạn cung cấp)
    const config = {
      apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
      authDomain: "test-game-8a541.firebaseapp.com",
      databaseURL: "https://test-game-8a541-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "test-game-8a541",
      storageBucket: "test-game-8a541.firebasestorage.app",
      messagingSenderId: "396403313237",
      appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
    };
    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM
    const authC = document.getElementById('authContainer');
    const emailI = document.getElementById('email');
    const passI = document.getElementById('pass');
    const regB = document.getElementById('btnRegister');
    const logB = document.getElementById('btnLogin');
    const hud = document.getElementById('hud');
    const hpEl = document.getElementById('hp');
    const killsEl = document.getElementById('kills');
    const msg = document.getElementById('message');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight; }
    window.addEventListener('resize', resize); resize();

    let uid;
    let players = {};
    let floats = [];

    regB.onclick = () => {
      createUserWithEmailAndPassword(auth, emailI.value, passI.value)
        .catch(e=>alert(e.message));
    };
    logB.onclick = () => {
      signInWithEmailAndPassword(auth, emailI.value, passI.value)
        .catch(e=>alert(e.message));
    };

    onAuthStateChanged(auth, user => {
      if(user){
        uid = user.uid;
        // init user kills if not exist
        const uRef = ref(db, `users/${uid}`);
        runTransaction(ref(db, `users/${uid}/kills`), k=> k||0);

        authC.style.display = 'none';
        hud.style.display = 'block';
        startGame();
      } else {
        authC.style.display = 'flex';
        hud.style.display = 'none';
      }
    });

    function startGame(){
      msg.textContent = 'Đang kết nối...';
      // spawn
      set(ref(db, `game/players/${uid}`), { x:canvas.width/2, y:canvas.height/2, health:100 });
      // listen players
      onValue(ref(db, 'game/players'), snap=>{
        players = snap.val()||{};
        msg.style.display = 'none';
      });
      // listen kills
      onValue(ref(db, `users/${uid}/kills`), snap=>{
        killsEl.textContent = snap.val();
      });
      loop();
    }

    window.addEventListener('mousemove', e=>{
      if(!players[uid]||players[uid].health<=0) return;
      update(ref(db, `game/players/${uid}`), { x:e.clientX, y:e.clientY });
    });

    window.addEventListener('click', e=>{
      Object.entries(players).forEach(([id,p])=>{
        if(id===uid||p.health<=0) return;
        const d = Math.hypot(e.clientX-p.x, e.clientY-p.y);
        if(d<30){
          const dmg = d<15?10:5;
          update(ref(db, `game/players/${id}`), { health: Math.max(0, p.health-dmg) });
          floats.push({ x:p.x, y:p.y-25, text:'-'+dmg+'hp', life:60 });
          if(p.health<=dmg){
            runTransaction(ref(db, `users/${uid}/kills`), k=> (k||0)+1);
            setTimeout(()=> update(ref(db, `game/players/${id}`), { health: 100 }), 30000);
          }
        }
      });
    });

    function loop(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      Object.entries(players).forEach(([id,p])=>{
        // health bar
        ctx.fillStyle='#444'; ctx.fillRect(p.x-20,p.y-40,40,6);
        ctx.fillStyle='#0f0'; ctx.fillRect(p.x-20,p.y-40,(p.health/100)*40,6);
        // stickman
        ctx.strokeStyle='#fff'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.arc(p.x,p.y-20,10,0,2*Math.PI); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y-10); ctx.lineTo(p.x,p.y+20); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x-15,p.y); ctx.lineTo(p.x+15,p.y); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y+20); ctx.lineTo(p.x-10,p.y+35); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(p.x,p.y+20); ctx.lineTo(p.x+10,p.y+35); ctx.stroke();
      });
      floats = floats.filter(f=>f.life>0);
      floats.forEach(f=>{
        ctx.globalAlpha = f.life/60;
        ctx.fillStyle='#ff0'; ctx.font='16px sans-serif'; ctx.fillText(f.text,f.x,f.y);
        f.y -= 0.5; f.life--;
        ctx.globalAlpha = 1;
      });
      const me = players[uid]||{};
      hp.textContent = me.health||0;
      requestAnimationFrame(loop);
    }

    window.addEventListener('beforeunload', ()=>{
      if(uid) remove(ref(db, `game/players/${uid}`));
    });
  </script>
</body>
</html>
