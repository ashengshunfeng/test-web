<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stickman Multiplayer Game (FINAL)</title>
  <style>
    body { margin: 0; overflow: hidden; background: #222; }
    #nicknameModal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.85); z-index: 10; display: flex; align-items: center; justify-content: center;
    }
    #nicknameBox {
      background: #fff; padding: 32px; border-radius: 16px; text-align: center;
      box-shadow: 0 6px 36px #0007;
    }
    #nicknameInput { font-size: 20px; padding: 12px; width: 230px; margin-bottom: 18px; }
    #nicknameBtn { padding: 12px 30px; font-size: 18px; border: none; background: #1877f2; color: #fff; border-radius: 8px; cursor: pointer; }
    #info { position: fixed; left: 12px; top: 10px; color: #fff; font-size: 22px; z-index: 2; font-family: Arial,sans-serif; }
  </style>
</head>
<body>
<div id="nicknameModal">
  <div id="nicknameBox">
    <h2>Chọn Nickname</h2>
    <input id="nicknameInput" maxlength="16" placeholder="Nickname...">
    <br>
    <button id="nicknameBtn">Vào game</button>
  </div>
</div>
<canvas id="game" width="1500" height="700"></canvas>
<div id="info"></div>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
// ĐÚNG THÔNG TIN FIREBASE CỦA BẠN!
const firebaseConfig = {
  apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
  authDomain: "test-game-8a541.firebaseapp.com",
  databaseURL: "https://test-game-8a541-default-rtdb.firebaseio.com",
  projectId: "test-game-8a541",
  storageBucket: "test-game-8a541.appspot.com",
  messagingSenderId: "396403313237",
  appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Màu stickman ngẫu nhiên mỗi người
function getRandomColor() {
  const colors = ["#35b6ff", "#44ff55", "#ff4545", "#ffee44", "#ff55ff", "#b184fd", "#fff", "#ff8800", "#ff55a3"];
  return colors[Math.floor(Math.random()*colors.length)];
}

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const info = document.getElementById('info');
let localId = null;
let nickname = "";
let color = "#fff";
let players = {};
let attackAnim = 0;
let attackTime = 0;
let isDead = false;
let hp = 100;
let kills = 0;
let showDamages = {};
let lastAttack = 0;

function showModal() {
  document.getElementById('nicknameModal').style.display = 'flex';
}
function hideModal() {
  document.getElementById('nicknameModal').style.display = 'none';
}
showModal();

document.getElementById('nicknameBtn').onclick = () => {
  const val = document.getElementById('nicknameInput').value.trim();
  if (val.length < 3) { alert('Nickname > 2 ký tự'); return; }
  nickname = val;
  color = getRandomColor();
  hideModal();
  connectGame();
}

document.getElementById('nicknameInput').addEventListener('keyup', e => {
  if(e.key==='Enter') document.getElementById('nicknameBtn').click();
});

// Vị trí
let x = Math.random()*canvas.width;
let y = Math.random()*canvas.height;
let mouse = {x, y};
canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});
canvas.addEventListener('mousedown', e => {
  if(isDead) return;
  if(Date.now() - lastAttack < 350) return;
  lastAttack = Date.now();
  attackAnim = 1; attackTime = Date.now();
  // Khi vung kiếm, kiểm tra va chạm
  for(const pid in players){
    if(pid === localId) continue;
    const p = players[pid];
    if(!p) continue;
    if(p.dead) continue;
    if(distance(x,y,p.x,p.y) < 60 && Date.now() - (p.hit||0) > 500){
      let dmg = 5 + Math.floor(Math.random()*6); // 5-10 dame
      sendAttack(pid, dmg);
    }
  }
});

function sendAttack(pid, dmg){
  db.ref(`players/${pid}/damage`).set({by: localId, value: dmg, time:Date.now()});
}

function distance(x1,y1,x2,y2){
  return Math.sqrt((x1-x2)**2 + (y1-y2)**2);
}

function connectGame(){
  const playerRef = db.ref('players').push();
  localId = playerRef.key;
  playerRef.set({nickname, color, x, y, health:100, dead:false, kills:0, respawn:0});
  playerRef.onDisconnect().remove();

  db.ref('players').on('value', snap => {
    players = snap.val() || {};
  });
  db.ref(`players/${localId}/damage`).on('value', snap => {
    const data = snap.val();
    if(data && data.value){
      hp -= data.value;
      showDamages[localId] = {time: Date.now(), val: -data.value};
      db.ref(`players/${localId}/damage`).remove();
      db.ref(`players/${localId}`).update({health: hp});
      if(hp<=0){
        db.ref(`players/${localId}`).update({dead:true, respawn: Date.now()+30000});
        isDead = true;
        setTimeout(()=>{
          hp=100; isDead=false;
          x=Math.random()*canvas.width;
          y=Math.random()*canvas.height;
          db.ref(`players/${localId}`).update({health:100, dead:false, x, y, respawn:0});
        }, 30000);
      }
    }
  });
  db.ref(`players`).on('child_changed', snap => {
    const d = snap.val();
    if(d.dead && d.respawn > Date.now() && d.killer){
      if(localId === d.killer){
        kills++;
        db.ref(`players/${localId}`).update({kills});
      }
    }
  });
  setInterval(()=>{
    if(localId){
      if(!isDead){
        x += (mouse.x - x) * 0.13;
        y += (mouse.y - y) * 0.13;
      }
      db.ref(`players/${localId}`).update({x, y, health:hp, kills, dead:isDead});
    }
  }, 55);
  renderLoop();
}

function renderStickman(x, y, c, dead, nickname, health, showDmg, respawn) {
  ctx.save();
  ctx.strokeStyle = c; ctx.lineWidth=4;
  ctx.translate(x, y);
  if(dead){
    ctx.rotate(Math.PI/2);
  }
  // Nickname
  ctx.font='bold 19px Arial';
  ctx.fillStyle='#fff';
  ctx.textAlign='center';
  ctx.fillText(nickname,0,-72);
  // Thanh máu
  ctx.fillStyle='lime';
  ctx.fillRect(-24,-59, Math.max(0,health/100*48),5);
  ctx.strokeStyle='#fff'; ctx.lineWidth=1;
  ctx.strokeRect(-24,-59,48,5);
  // HP text
  ctx.font='14px Arial';
  ctx.fillStyle='#fff';
  ctx.fillText(health+"/100",0,-63);
  // Hiệu ứng số máu
  if(showDmg && Date.now() - showDmg.time < 1100){
    ctx.save();
    ctx.font = 'bold 21px Arial';
    ctx.fillStyle = '#ff0';
    ctx.globalAlpha = 1-(Date.now()-showDmg.time)/1100;
    ctx.fillText(`${showDmg.val>0?'+':''}${showDmg.val}hp`,0,-95);
    ctx.restore();
  }
  // Thân
  ctx.strokeStyle = c; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(0,-30); ctx.lineTo(0,10); ctx.stroke();
  // Chân
  ctx.beginPath(); ctx.moveTo(0,10); ctx.lineTo(-12,36); ctx.moveTo(0,10); ctx.lineTo(12,36); ctx.stroke();
  // Tay
  ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(-16,8); ctx.moveTo(0,-12); ctx.lineTo(16,8); ctx.stroke();
  // Đầu
  ctx.beginPath(); ctx.arc(0,-38,12,0,2*Math.PI); ctx.stroke();
  // Vũ khí: Kiếm dài, có thể chém
  ctx.save();
  ctx.strokeStyle = '#f22'; ctx.lineWidth=8;
  if(!dead && attackAnim>0 && !respawn){
    let a = Math.min(1,(Date.now()-attackTime)/140);
    ctx.rotate(-a*0.9);
    ctx.beginPath(); ctx.moveTo(16,8); ctx.lineTo(108,8); ctx.stroke();
    // Gió chém
    if(a>0.4) {
      ctx.globalAlpha=0.3+0.6*(a-0.4);
      ctx.strokeStyle='#fff'; ctx.lineWidth=4;
      ctx.beginPath(); ctx.moveTo(105,8); ctx.lineTo(160,6+Math.sin(a*12)*6); ctx.stroke();
      ctx.globalAlpha=1;
    }
  } else {
    ctx.beginPath(); ctx.moveTo(16,8); ctx.lineTo(90,8); ctx.stroke();
  }
  ctx.restore();
  // Animation chết: nằm sấp và đếm thời gian hồi sinh
  if(dead && respawn){
    ctx.font='16px Arial';
    ctx.fillStyle='#ff8080';
    let secs = Math.max(0, Math.floor((respawn-Date.now())/1000));
    ctx.fillText("Hồi sinh sau: "+secs+"s",0,44);
  }
  ctx.restore();
}

function renderLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  info.textContent = `HP: ${hp} | Kills: ${kills}`;
  for(const pid in players){
    const p = players[pid];
    if(!p) continue;
    renderStickman(p.x, p.y, p.color||'#fff', p.dead, p.nickname, p.health||100, showDamages[pid], p.respawn);
  }
  // Chém hiệu ứng
  if(attackAnim>0){
    let a = Math.min(1,(Date.now()-attackTime)/140);
    ctx.save();
    ctx.translate(x, y);
    ctx.strokeStyle = '#ff0'; ctx.lineWidth=7;
    ctx.globalAlpha = 1-a;
    ctx.beginPath(); ctx.moveTo(35,12); ctx.lineTo(170,-60+120*a); // hiệu ứng gió
    ctx.stroke();
    ctx.restore();
    if(a>=1) attackAnim=0;
  }
  requestAnimationFrame(renderLoop);
}
</script>
</body>
</html>
