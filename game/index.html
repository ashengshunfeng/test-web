<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Stickman Multiplayer Game - Animated</title>
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    body { background: #222; width: 100vw; height: 100vh; overflow: hidden; }
    #gameCanvas { background: #222; display: block; margin: 0 auto; position: absolute; top: 0; left: 0; right: 0; bottom: 0; }
    #nicknameForm {
      position: absolute; left: 50%; top: 35%; transform: translate(-50%, -50%); z-index: 10;
      background: rgba(30,30,30,0.97); padding: 32px 38px; border-radius: 10px; box-shadow: 0 2px 16px #0007;
      display: flex; flex-direction: column; align-items: center; gap: 12px; border: 1px solid #333; min-width: 340px;
    }
    #nicknameForm input { font-size: 20px; padding: 8px; border-radius: 5px; border: 1px solid #444; }
    #nicknameForm button { font-size: 20px; padding: 8px 18px; border-radius: 5px; border: none; background: #1877f2; color: #fff; cursor: pointer; }
  </style>
</head>
<body>
  <div id="nicknameForm">
    <h2 style="color:#fff;margin-bottom:0">Đặt Nickname</h2>
    <input id="nicknameInput" maxlength="12" placeholder="Nhập nickname..." />
    <button id="joinBtn">Vào game</button>
  </div>
  <canvas id="gameCanvas" width="1280" height="650"></canvas>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
// --- Config ---
const firebaseConfig = {
  apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
  authDomain: "test-game-8a541.firebaseapp.com",
  databaseURL: "https://test-game-8a541-default-rtdb.firebaseio.com",
  projectId: "test-game-8a541",
  storageBucket: "test-game-8a541.appspot.com",
  messagingSenderId: "396403313237",
  appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- Utils ---
function randomColor() {
  const colors = ["#43e", "#e43", "#09d", "#ee0", "#0e6", "#fd0", "#e09", "#0fa", "#fa0", "#999"];
  return colors[Math.floor(Math.random()*colors.length)];
}

function lerp(a,b,t){ return a + (b-a)*t; }

// --- Game state ---
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let localId = null;
let localPlayer = null;
let nickname = '';
let players = {};
let lastSent = 0;
let attackCooldown = 0;
let swordAnim = 0;
let attackEffect = null;
let dying = false;
let reviveTimeout = null;
let damageTexts = [];

// --- Animation Helper ---
function drawStickman(x, y, color, facing, anim, showSword, swordSwing, dead, nickname, hp, maxHp) {
  ctx.save();
  ctx.translate(x, y);

  // Dead effect: rotate body, fade color
  if(dead) ctx.rotate(Math.PI/2);

  // Body
  ctx.lineWidth = 5;
  ctx.strokeStyle = color;
  // Head
  ctx.beginPath();
  ctx.arc(0, -30, 20, 0, 2*Math.PI);
  ctx.stroke();

  // Face
  if(dead) {
    // X_X face
    ctx.font = "14px Arial";
    ctx.fillStyle = '#fff';
    ctx.fillText('x x', -14, -28);
  } else if(anim=='smile') {
    ctx.beginPath(); ctx.arc(0, -23, 10, Math.PI*0.15, Math.PI*0.85);
    ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.stroke();
  } else if(anim=='cry') {
    ctx.beginPath(); ctx.arc(0, -20, 8, Math.PI*1.2, Math.PI*1.8);
    ctx.strokeStyle = '#1cf'; ctx.lineWidth=2; ctx.stroke();
    // Tear drop
    ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(0,0); ctx.strokeStyle="#1cf"; ctx.lineWidth=2; ctx.stroke();
  }

  // Body
  ctx.strokeStyle = color; ctx.lineWidth = 5;
  ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(0,40); ctx.stroke(); // spine
  // Legs
  ctx.beginPath(); ctx.moveTo(0,40); ctx.lineTo(-18,80); ctx.moveTo(0,40); ctx.lineTo(18,80); ctx.stroke();
  // Arms
  // Animate arm swing for attack
  ctx.beginPath();
  if (showSword && swordSwing>0) {
    // Right arm swings up
    ctx.moveTo(0,5); ctx.lineTo(lerp(0,38,swordSwing), lerp(0,2-45,swordSwing));
    // Left arm
    ctx.moveTo(0,10); ctx.lineTo(-28, 0);  
  } else {
    // Neutral pose
    ctx.moveTo(0,5); ctx.lineTo(30,5); // Right
    ctx.moveTo(0,10); ctx.lineTo(-28, 0);  // Left
  }
  ctx.stroke();

  // Sword
  if(showSword) {
    ctx.save();
    ctx.strokeStyle="#f33"; ctx.lineWidth=7;
    ctx.translate(lerp(30,38,swordSwing), lerp(5,2-45,swordSwing));
    ctx.rotate(-Math.PI*0.3*swordSwing);
    ctx.beginPath();
    ctx.moveTo(0,0); ctx.lineTo(62,0);
    ctx.stroke();
    // Wind effect
    if(swordSwing>0.75){
      ctx.globalAlpha = (swordSwing-0.75)*3;
      ctx.strokeStyle="#fff8";
      for(let i=0;i<4;i++){
        ctx.beginPath(); ctx.moveTo(68,0); ctx.lineTo(100+10*i,Math.sin(performance.now()/100+i*2)*8);
        ctx.stroke();
      }
      ctx.globalAlpha = 1;
    }
    ctx.restore();
  }

  // Blood splat
  if(anim==="blood") {
    for(let i=0;i<6;i++){
      ctx.save();
      ctx.rotate(Math.PI*i/3 + Math.random()*0.12);
      ctx.fillStyle="#e11";
      ctx.globalAlpha=0.7;
      ctx.beginPath();
      ctx.ellipse(25,0,6+Math.random()*6,2+Math.random()*2,0,0,2*Math.PI);
      ctx.fill();
      ctx.restore();
    }
  }

  // HP bar
  ctx.save();
  ctx.translate(0, -60);
  // Nickname
  ctx.font = "bold 19px Arial";
  ctx.fillStyle = '#fff';
  ctx.textAlign = "center";
  ctx.fillText(nickname, 0, -13);
  // HP
  ctx.strokeStyle = "#222"; ctx.lineWidth=9;
  ctx.beginPath(); ctx.moveTo(-32,0); ctx.lineTo(32,0); ctx.stroke();
  ctx.strokeStyle = "#0f4"; ctx.lineWidth=7;
  ctx.beginPath(); ctx.moveTo(-32,0); ctx.lineTo(-32+64*Math.max(0,hp/maxHp),0); ctx.stroke();
  ctx.restore();

  ctx.restore();
}

function drawDamageText(x, y, text, color) {
  ctx.save();
  ctx.font = "bold 22px Arial";
  ctx.fillStyle = color;
  ctx.globalAlpha = 0.85;
  ctx.fillText(text, x, y);
  ctx.restore();
}

// --- Multiplayer ---
function connectPlayer(nickname) {
  localId = 'p_' + Math.random().toString(36).slice(2,8);
  const color = randomColor();
  localPlayer = {
    nickname,
    color,
    x: Math.random()*canvas.width*0.8+80,
    y: Math.random()*canvas.height*0.7+60,
    hp: 100,
    maxHp: 100,
    facing: 1,
    alive: true,
    swordAnim: 0,
    kills: 0,
    state: 'idle',
    t: Date.now(),
  };
  db.ref('players/'+localId).set(localPlayer);
  db.ref('players/'+localId).onDisconnect().remove();
}

function listenPlayers() {
  db.ref('players').on('value', snap => {
    players = snap.val()||{};
  });
}

function updatePlayer(obj) {
  if(localId) db.ref('players/'+localId).update(obj);
}

function sendHit(targetId, dmg) {
  if(!players[targetId]||!players[targetId].alive) return;
  db.ref('players/'+targetId).transaction(p => {
    if(!p || !p.alive) return;
    p.hp -= dmg;
    if(p.hp <= 0) {
      p.hp = 0;
      p.alive = false;
      p.state = 'cry';
      p.dieTime = Date.now();
    }
    return p;
  });
  // Blood effect for local display
  if(targetId!==localId) {
    let op = players[targetId];
    if(op) op.anim = 'blood';
  }
}

function tryRevive() {
  if(!localPlayer) return;
  if(localPlayer.hp<=0 && !localPlayer.alive) {
    updatePlayer({ hp:100, alive:true, state:'idle', dieTime:null });
  }
}

// --- Game Loop ---
let mouse={x:canvas.width/2,y:canvas.height/2}, clicked=false;
canvas.addEventListener('mousemove',e=>{
  mouse.x = e.offsetX; mouse.y = e.offsetY;
});
canvas.addEventListener('mousedown',e=>{
  clicked=true;
});
document.getElementById('joinBtn').onclick = function(){
  let n = document.getElementById('nicknameInput').value.trim();
  if(!n) return alert('Nhập nickname trước!');
  nickname = n.slice(0,16);
  document.getElementById('nicknameForm').style.display = 'none';
  connectPlayer(nickname);
  listenPlayers();
  gameLoop();
};

function gameLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  // Draw all players
  for(const [id, p] of Object.entries(players)){
    let dead = !p.alive;
    let anim = (p.state||'idle');
    let swordSwing = 0;
    if(p.swordAnim) swordSwing = Math.max(0,Math.min(1,(performance.now()-p.swordAnim)/200));
    if(p.hp<=0 && p.dieTime && Date.now()-p.dieTime>29500 && id===localId) {
      // 30s passed, revive
      tryRevive();
    }
    drawStickman(p.x, p.y, p.color, p.facing, anim, true, swordSwing, dead, p.nickname||id, p.hp||0, p.maxHp||100);
  }
  // Damage texts
  for(let i=damageTexts.length-1; i>=0; i--){
    let t = damageTexts[i];
    t.y -= 1.5;
    t.life -= 1;
    drawDamageText(t.x, t.y, t.text, t.color);
    if(t.life<=0) damageTexts.splice(i,1);
  }
  // My info
  if(localPlayer){
    ctx.save();
    ctx.font = '22px Arial'; ctx.fillStyle='#fff';
    ctx.fillText(`HP: ${localPlayer.hp||0} | Kills: ${localPlayer.kills||0}`, 10, 26);
    ctx.restore();
  }
  requestAnimationFrame(gameLoop);
}

setInterval(()=>{
  if(!localPlayer||!localId) return;
  // Movement towards mouse
  if(localPlayer.alive){
    localPlayer.x = lerp(localPlayer.x, mouse.x, 0.17);
    localPlayer.y = lerp(localPlayer.y, mouse.y, 0.17);
    updatePlayer({ x: localPlayer.x, y: localPlayer.y, facing: mouse.x>localPlayer.x?1:-1 });
  }
}, 45);

setInterval(()=>{
  if(!localPlayer||!localId) return;
  // Revive after 30s if dead
  if(localPlayer.hp<=0 && !localPlayer.alive && localPlayer.dieTime && Date.now()-localPlayer.dieTime>29500){
    tryRevive();
  }
}, 4000);

// Attack logic
canvas.addEventListener('mouseup', function(){
  if(!localPlayer || !localPlayer.alive) return;
  if(Date.now()-attackCooldown<470) return;
  attackCooldown = Date.now();
  localPlayer.swordAnim = performance.now();
  updatePlayer({ swordAnim: localPlayer.swordAnim, state: 'smile' });
  setTimeout(()=>updatePlayer({ state: 'idle' }),500);
  // Detect hits
  for(const [id,p] of Object.entries(players)){
    if(id===localId||!p.alive) continue;
    // Hit test: if their head is near sword
    let dx = p.x - localPlayer.x;
    let dy = p.y - localPlayer.y;
    let dist = Math.sqrt(dx*dx+dy*dy);
    if(dist<70){
      // Headshot
      sendHit(id, 10);
      damageTexts.push({ x:p.x, y:p.y-64, text:"-10hp", color:'#ff0', life:36 });
      // Tăng kills nếu chết
      if((p.hp||100)-10<=0){
        localPlayer.kills = (localPlayer.kills||0)+1;
        updatePlayer({ kills: localPlayer.kills });
      }
    }else if(dist<120){
      // Body shot
      sendHit(id, 5);
      damageTexts.push({ x:p.x, y:p.y-64, text:"-5hp", color:'#fa0', life:30 });
    }
  }
});

// Add blood anim locally
setInterval(()=>{
  for(const [id,p] of Object.entries(players)){
    if(p.anim=='blood'){ p.anim='idle'; updatePlayer({ state:'idle' }); }
  }
},400);

  </script>
</body>
</html>
