<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stickman Minimal Run</title>
  <style>
    body { margin: 0; overflow: hidden; background: #222; }
    #nicknameModal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.9); z-index: 10; display: flex; align-items: center; justify-content: center;
    }
    #nicknameBox {
      background: #fff; padding: 32px; border-radius: 16px; text-align: center;
    }
    #nicknameInput { font-size: 20px; padding: 12px; width: 230px; margin-bottom: 18px; }
    #nicknameBtn { padding: 12px 30px; font-size: 18px; border: none; background: #1877f2; color: #fff; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>
<div id="nicknameModal">
  <div id="nicknameBox">
    <h2>Nickname</h2>
    <input id="nicknameInput" maxlength="16" placeholder="Nickname...">
    <br>
    <button id="nicknameBtn">VÃ o game</button>
  </div>
</div>
<canvas id="game" width="900" height="550"></canvas>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyDCcrfHUbnpcQMCxoF1mxwUoE9wOJR2_GE",
  authDomain: "test-game-8a541.firebaseapp.com",
  databaseURL: "https://test-game-8a541-default-rtdb.firebaseio.com",
  projectId: "test-game-8a541",
  storageBucket: "test-game-8a541.appspot.com",
  messagingSenderId: "396403313237",
  appId: "1:396403313237:web:3eeb142c4ffaffbd5962dc"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let players = {};
let nickname = "";
let color = "#" + Math.floor(Math.random()*16777215).toString(16);
let x = Math.random()*canvas.width;
let y = Math.random()*canvas.height;
let localId = null;

function showModal() {
  document.getElementById('nicknameModal').style.display = 'flex';
}
function hideModal() {
  document.getElementById('nicknameModal').style.display = 'none';
}
showModal();

document.getElementById('nicknameBtn').onclick = () => {
  const val = document.getElementById('nicknameInput').value.trim();
  if (val.length < 2) { alert('Nickname?'); return; }
  nickname = val;
  hideModal();
  connectGame();
}

document.getElementById('nicknameInput').addEventListener('keyup', e => {
  if(e.key==='Enter') document.getElementById('nicknameBtn').click();
});

canvas.addEventListener('mousemove', e => {
  const rect = canvas.getBoundingClientRect();
  x = e.clientX - rect.left;
  y = e.clientY - rect.top;
});

function connectGame(){
  const ref = db.ref('players').push();
  localId = ref.key;
  ref.set({nickname, color, x, y});
  ref.onDisconnect().remove();
  setInterval(()=>{
    if(localId) db.ref('players/'+localId).update({x,y});
  },60);
  db.ref('players').on('value', snap => {
    players = snap.val()||{};
  });
  renderLoop();
}

function renderStick(x, y, color, nickname){
  ctx.save();
  ctx.strokeStyle=color; ctx.lineWidth=4;
  ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y+40); ctx.stroke();
  ctx.beginPath(); ctx.arc(x, y-12, 10, 0, 2*Math.PI); ctx.stroke();
  ctx.font = 'bold 15px Arial';
  ctx.fillStyle = '#fff';
  ctx.textAlign='center';
  ctx.fillText(nickname, x, y-22);
  ctx.restore();
}

function renderLoop(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const pid in players){
    const p = players[pid];
    if(p) renderStick(p.x, p.y, p.color||'#fff', p.nickname||'');
  }
  requestAnimationFrame(renderLoop);
}
</script>
</body>
</html>
